{% extends "base.html" %}
{% load static %}

{% block title %}Создание услуги - {{ autoservice.name }}{% endblock title %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Заголовок -->
            <div class="d-flex align-items-center mb-4">
                <a href="{% url 'core:autoservice_services_list' %}" class="btn btn-outline-secondary me-3">
                    <i class="bi bi-arrow-left"></i>
                </a>
                <div>
                    <h1 class="text-primary mb-1">
                        <i class="bi bi-plus-circle me-2"></i>
                        Создание новой услуги
                    </h1>
                    <p class="text-muted mb-0">
                        <i class="bi bi-building me-1"></i>
                        {{ autoservice.name }}
                    </p>
                </div>
            </div>

            <!-- Форма создания услуги -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-gear me-2"></i>
                        Информация об услуге
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- Стандартная услуга -->
                        <div class="mb-4">
                            <label for="{{ form.standard_service.id_for_label }}" class="form-label">
                                <i class="bi bi-bookmark me-1"></i>
                                {{ form.standard_service.label }}
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.standard_service }}
                            {% if form.standard_service.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.standard_service.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Выберите стандартную услугу из каталога. Это поможет клиентам легче найти вашу услугу.
                            </div>
                        </div>

                        <!-- Название услуги -->
                        <div class="mb-4">
                            <label for="{{ form.name.id_for_label }}" class="form-label">
                                <i class="bi bi-type me-1"></i>
                                {{ form.name.label }}
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.name }}
                            {% if form.name.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.name.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Укажите конкретное название услуги в вашем автосервисе.
                            </div>
                        </div>

                        <!-- Цена и длительность в одной строке -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="{{ form.price.id_for_label }}" class="form-label">
                                    <i class="bi bi-currency-exchange me-1"></i>
                                    {{ form.price.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    {{ form.price }}
                                    <span class="input-group-text">₽</span>
                                </div>
                                {% if form.price.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.price.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    Стоимость услуги в рублях.
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="{{ form.duration.id_for_label }}" class="form-label">
                                    <i class="bi bi-clock me-1"></i>
                                    {{ form.duration.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    {{ form.duration }}
                                    <span class="input-group-text">мин</span>
                                </div>
                                {% if form.duration.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.duration.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    Время выполнения в минутах.
                                </div>
                            </div>
                        </div>

                        <!-- Описание -->
                        <div class="mb-4">
                            <label for="{{ form.description.id_for_label }}" class="form-label">
                                <i class="bi bi-file-text me-1"></i>
                                {{ form.description.label }}
                            </label>
                            {{ form.description }}
                            {% if form.description.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.description.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Подробное описание услуги, что включено в работу, особенности выполнения.
                            </div>
                        </div>

                        <!-- Изображение -->
                        <div class="mb-4">
                            <label for="{{ form.image.id_for_label }}" class="form-label">
                                <i class="bi bi-image me-1"></i>
                                {{ form.image.label }}
                            </label>
                            {{ form.image }}
                            {% if form.image.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.image.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Загрузите фотографию, демонстрирующую услугу (необязательно).
                            </div>
                        </div>

                        <!-- Чекбоксы -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.is_popular }}
                                    <label class="form-check-label" for="{{ form.is_popular.id_for_label }}">
                                        <i class="bi bi-star me-1"></i>
                                        {{ form.is_popular.label }}
                                    </label>
                                </div>
                                <div class="form-text ms-4">
                                    Популярные услуги выделяются в списке.
                                </div>
                                {% if form.is_popular.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.is_popular.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.is_active }}
                                    <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                        <i class="bi bi-check-circle me-1"></i>
                                        {{ form.is_active.label }}
                                    </label>
                                </div>
                                <div class="form-text ms-4">
                                    Неактивные услуги не показываются клиентам.
                                </div>
                                {% if form.is_active.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.is_active.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Общие ошибки формы -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                {{ form.non_field_errors.0 }}
                            </div>
                        {% endif %}

                        <!-- Кнопки -->
                        <div class="d-flex gap-3">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg me-2"></i>
                                Создать услугу
                            </button>
                            
                            <a href="{% url 'core:autoservice_services_list' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-lg me-2"></i>
                                Отмена
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Информационная панель -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="bi bi-lightbulb me-2"></i>
                                Совет
                            </h6>
                            <p class="card-text small mb-0">
                                Выбирайте стандартную услугу соответствующую вашей работе - это поможет клиентам легче найти вас в поиске.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card bg-warning text-dark">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Важно
                            </h6>
                            <p class="card-text small mb-0">
                                Указывайте реальную стоимость и время выполнения услуги для избежания недоразумений с клиентами.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Стили для группировки опций в select */
#id_standard_service option[value=""] {
    font-weight: bold;
    color: #6c757d;
}

/* Индикатор загрузки для формы */
.form-loading {
    opacity: 0.7;
    pointer-events: none;
}

/* Анимация для карточек */
.card {
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
}

/* Улучшенные стили для input-group */
.input-group .form-control {
    border-right: 0;
}

.input-group .input-group-text {
    background-color: rgba(13, 110, 253, 0.1);
    border-color: #0d6efd;
    color: #0d6efd;
    font-weight: 500;
}

/* Стили для предварительного просмотра изображения */
.image-preview {
    max-width: 200px;
    max-height: 200px;
    margin-top: 10px;
    border-radius: 8px;
    border: 2px solid #dee2e6;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Автоматическое заполнение названия услуги при выборе стандартной услуги
    const standardServiceSelect = document.getElementById('id_standard_service');
    const nameInput = document.getElementById('id_name');
    const durationInput = document.getElementById('id_duration');
    
    if (standardServiceSelect && nameInput) {
        standardServiceSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const text = selectedOption.text;
            
            // Извлекаем название услуги (убираем префиксы и дополнительную информацию)
            if (text.includes('└')) {
                let serviceName = text.split('└')[1].trim();
                // Убираем информацию в скобках (время, цена)
                serviceName = serviceName.split('(')[0].trim();
                nameInput.value = serviceName;
            }
        });
    }
    
    // Предварительный просмотр изображения
    const imageInput = document.querySelector('input[type="file"]');
    if (imageInput) {
        imageInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Удаляем предыдущий preview если есть
                    const existingPreview = document.querySelector('.image-preview');
                    if (existingPreview) {
                        existingPreview.remove();
                    }
                    
                    // Создаем новый preview
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'image-preview';
                    img.alt = 'Предварительный просмотр';
                    
                    // Вставляем после input
                    imageInput.parentNode.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Индикатор загрузки при отправке формы
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function() {
            form.classList.add('form-loading');
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Создание...';
            }
        });
    }
});
</script>
{% endblock content %}
