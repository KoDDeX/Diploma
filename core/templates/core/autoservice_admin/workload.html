{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Заголовок и управление -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="bi bi-calendar3"></i> {{ title }}</h1>
                <div>
                    <a href="{% url 'core:autoservice_admin_dashboard' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> К панели управления
                    </a>
                </div>
            </div>

            <!-- Панель управления датой и режимом -->
            <div class="card bg-dark border-secondary mb-4">
                <div class="card-body">
                    <form method="get" class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label for="date" class="form-label text-light">Дата</label>
                            <input type="date" name="date" id="date" class="form-control bg-secondary text-light border-secondary" 
                                value="{{ selected_date|date:'Y-m-d' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="mode" class="form-label text-light">Режим отображения</label>
                            <select name="mode" id="mode" class="form-select bg-secondary text-light border-secondary">
                                <option value="day" {% if view_mode == 'day' %}selected{% endif %}>День</option>
                                <option value="week" {% if view_mode == 'week' %}selected{% endif %}>Неделя</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-arrow-clockwise"></i> Обновить
                            </button>
                        </div>
                        <div class="col-md-4 text-end">
                            <small class="text-light">
                                {% if view_mode == 'week' %}
                                    Неделя: {{ start_date|date:"d.m.Y" }} - {{ end_date|date:"d.m.Y" }}
                                {% else %}
                                    Дата: {{ selected_date|date:"d.m.Y" }}
                                {% endif %}
                            </small>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Быстрая навигация по датам -->
            <div class="card bg-dark border-secondary mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-center gap-2 flex-wrap">
                        <a href="?date={{ selected_date|add_days:-1|date:'Y-m-d' }}&mode={{ view_mode }}" 
                           class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-chevron-left"></i> 
                            {% if view_mode == 'week' %}Предыдущая неделя{% else %}Предыдущий день{% endif %}
                        </a>
                        <a href="?mode={{ view_mode }}" class="btn btn-secondary btn-sm">
                            <i class="bi bi-house"></i> Сегодня
                        </a>
                        <a href="?date={{ selected_date|add_days:1|date:'Y-m-d' }}&mode={{ view_mode }}" 
                           class="btn btn-outline-secondary btn-sm">
                            {% if view_mode == 'week' %}Следующая неделя{% else %}Следующий день{% endif %}
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Легенда -->
            <div class="card bg-dark border-secondary mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h6 class="text-light mb-3">Условные обозначения:</h6>
                            <div class="d-flex flex-wrap gap-3">
                                <div class="d-flex align-items-center">
                                    <div class="bg-success" style="width: 20px; height: 20px; border-radius: 3px;"></div>
                                    <span class="text-light ms-2">Свободно</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="bg-danger" style="width: 20px; height: 20px; border-radius: 3px;"></div>
                                    <span class="text-light ms-2">Занято</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="bg-warning" style="width: 20px; height: 20px; border-radius: 3px;"></div>
                                    <span class="text-light ms-2">В работе</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <small class="text-muted">
                                Рабочие часы: {{ work_start|time:"H:i" }} - {{ work_end|time:"H:i" }}
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Панель загрузки -->
            <div class="card bg-dark border-secondary">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-dark table-bordered">
                            <thead>
                                <tr>
                                    <th class="sticky-left">Мастер</th>
                                    {% if view_mode == 'week' %}
                                        {% for date in dates_range %}
                                        <th class="text-center">
                                            {{ date|date:"D" }}<br>
                                            <small>{{ date|date:"d.m" }}</small>
                                        </th>
                                        {% endfor %}
                                    {% else %}
                                        {% for slot in time_slots %}
                                        <th class="text-center time-slot">
                                            {{ slot|time:"H:i" }}
                                        </th>
                                        {% endfor %}
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for master_id, master_data in workload_data.items %}
                                <tr>
                                    <td class="sticky-left">
                                        <strong class="text-light">{{ master_data.master.get_full_name|default:master_data.master.username }}</strong>
                                    </td>
                                    {% if view_mode == 'week' %}
                                        {% for date in dates_range %}
                                        <td class="text-center p-1">
                                            {% with day_data=master_data.dates|get_item:date %}
                                            <div class="day-summary">
                                                {% if day_data.orders %}
                                                    <small class="text-info">{{ day_data.orders|length }} заказ{{ day_data.orders|length|pluralize:"а,ов" }}</small>
                                                    {% for order in day_data.orders %}
                                                    <div class="order-preview bg-primary text-white p-1 rounded mb-1" 
                                                         title="Заказ №{{ order.id }} - {{ order.service.name }} ({{ order.preferred_time|time:'H:i' }})">
                                                        <small>
                                                            {{ order.preferred_time|time:"H:i" }}<br>
                                                            {{ order.service.name|truncatechars:15 }}
                                                        </small>
                                                    </div>
                                                    {% endfor %}
                                                {% else %}
                                                    <small class="text-success">Свободен</small>
                                                {% endif %}
                                            </div>
                                            {% endwith %}
                                        </td>
                                        {% endfor %}
                                    {% else %}
                                        {% with day_data=master_data.dates|get_item:selected_date %}
                                        {% for slot in time_slots %}
                                        {% with slot_data=day_data.time_slots|get_item:slot %}
                                        <td class="text-center p-1 time-cell" 
                                            data-master="{{ master_data.master.id }}" 
                                            data-time="{{ slot|time:'H:i' }}">
                                            {% if slot_data.status == 'busy' %}
                                                <div class="bg-danger text-white p-1 rounded order-cell" 
                                                     title="Заказ №{{ slot_data.order.id }} - {{ slot_data.order.service.name }}">
                                                    <small>
                                                        №{{ slot_data.order.id }}<br>
                                                        {{ slot_data.order.service.name|truncatechars:10 }}
                                                    </small>
                                                </div>
                                            {% else %}
                                                <div class="bg-success p-1 rounded free-cell" title="Свободно">
                                                    <small class="text-white">Свободно</small>
                                                </div>
                                            {% endif %}
                                        {% endwith %}
                                        </td>
                                        {% endfor %}
                                        {% endwith %}
                                    {% endif %}
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="100%" class="text-center text-muted py-4">
                                        Нет мастеров в автосервисе
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Заказы без мастера -->
            {% if unassigned_orders %}
            <div class="card bg-dark border-secondary mt-4">
                <div class="card-header">
                    <h5 class="text-warning mb-0">
                        <i class="bi bi-exclamation-triangle"></i>
                        Заказы без назначенного мастера ({{ unassigned_orders|length }})
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for order in unassigned_orders %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card bg-warning text-dark">
                                <div class="card-body p-3">
                                    <h6 class="card-title">Заказ №{{ order.id }}</h6>
                                    <p class="card-text mb-1">
                                        <strong>Услуга:</strong> {{ order.service.name }}<br>
                                        <strong>Клиент:</strong> {{ order.get_client_name }}<br>
                                        <strong>Дата:</strong> {{ order.preferred_date|date:"d.m.Y" }}<br>
                                        <strong>Время:</strong> {{ order.preferred_time|time:"H:i" }}<br>
                                        <strong>Длительность:</strong> {{ order.estimated_duration|format_duration }}
                                    </p>
                                    <a href="{% url 'core:autoservice_order_detail' order.id %}" 
                                       class="btn btn-dark btn-sm">
                                        <i class="bi bi-gear"></i> Управление
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.sticky-left {
    position: sticky;
    left: 0;
    background-color: var(--bs-dark);
    z-index: 1;
    min-width: 150px;
}

.time-slot {
    min-width: 80px;
}

.time-cell {
    width: 80px;
    height: 60px;
    vertical-align: middle;
}

.order-cell, .free-cell {
    min-height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8em;
}

.order-preview {
    font-size: 0.75em;
    line-height: 1.2;
}

.day-summary {
    min-height: 80px;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

@media (max-width: 768px) {
    .time-slot {
        min-width: 60px;
    }
    
    .time-cell {
        width: 60px;
        height: 50px;
    }
    
    .sticky-left {
        min-width: 120px;
    }
}
</style>
{% endblock %}
